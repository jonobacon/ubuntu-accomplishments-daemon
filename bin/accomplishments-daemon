#!/usr/bin/twistd -y
"""
Run the Accomplishments daemon!
"""
import sys
import os

from twisted.internet import gireactor
gireactor.install()

import dbus
from dbus.mainloop.glib import DBusGMainLoop


# Importing from accomplishments.paths would fail, if the path is set wrongly.
# We need to ensure that the script will load the correct version of
# accomplishment.* that is installed with this script.
scriptpath = os.path.abspath(__file__)
# basepaths shall be equal to prefix used while installing - if the application is run from source, it does not really matter.
basepath = os.path.split(os.path.split(scriptpath)[0])[0]
sys.path.insert(0, basepath)
sys.path.insert(0, basepath + "/lib/python2.7")
sys.path.insert(0, basepath + "/lib/python2.7/site-packages")
sys.path.insert(0, basepath + "/lib/python2.7/dist-packages")


# Ensure the sync daemon is running. The following command can be run in the
# background (&), because it would block the daemon from running for few
# seconds, while the syncdaemon will not be needed immediatelly after
# accomplishments daemon startups.
os.system("u1sdtool --start &")


from accomplishments.daemon import app

from accomplishments.util import paths

dbus_loop = DBusGMainLoop(set_as_default=True)
application = app.applicationFactory(
    app_name="Ubuntu Accomplishments",
    bus_name="org.ubuntu.accomplishments",
    main_loop=dbus_loop,
    session_bus=dbus.SessionBus(mainloop=dbus_loop),
    object_path="/",
    # Let's execute the timer service every 15 minutes
    update_interval=15 * 60,
    gpg_key=os.path.join(paths.systemdata_dir, "validation-key.pub"))



<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>accomplishments.daemon.api &mdash; Ubuntu Accomplishments Daemon 0.3 documentation</title>
    
    <link rel="stylesheet" href="../../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '0.3',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Ubuntu Accomplishments Daemon 0.3 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../../../index.html">Ubuntu Accomplishments Daemon 0.3 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for accomplishments.daemon.api</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">(c) 2012, Jono Bacon, and the Ubuntu Accomplishments community.</span>

<span class="sd">This is the core Ubuntu Accomplishments daemon API.</span>

<span class="sd">This file is licensed under the GNU Public License version 3.</span>

<span class="sd">If you are interested in contributing improvements or changes to this</span>
<span class="sd">program, please see http://wiki.ubuntu.com/Accomplishments for how to</span>
<span class="sd">get involved.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">gettext</span>
<span class="kn">from</span> <span class="nn">gettext</span> <span class="kn">import</span> <span class="n">gettext</span> <span class="k">as</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">gettext</span> <span class="kn">import</span> <span class="n">ngettext</span> <span class="k">as</span> <span class="n">N_</span>
<span class="kn">import</span> <span class="nn">ConfigParser</span>
<span class="kn">import</span> <span class="nn">Image</span><span class="o">,</span> <span class="nn">ImageEnhance</span>
<span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">gobject</span>
<span class="kn">import</span> <span class="nn">gpgme</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pwd</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">locale</span>

<span class="kn">import</span> <span class="nn">dbus</span>
<span class="kn">import</span> <span class="nn">dbus.service</span>

<span class="kn">from</span> <span class="nn">twisted.internet</span> <span class="kn">import</span> <span class="n">defer</span><span class="p">,</span> <span class="n">reactor</span>
<span class="kn">from</span> <span class="nn">twisted.internet.protocol</span> <span class="kn">import</span> <span class="n">ProcessProtocol</span>
<span class="kn">from</span> <span class="nn">twisted.python</span> <span class="kn">import</span> <span class="n">filepath</span>
<span class="kn">from</span> <span class="nn">twisted.python</span> <span class="kn">import</span> <span class="n">log</span>

<span class="kn">import</span> <span class="nn">xdg.BaseDirectory</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pynotify</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="n">pynotify</span> <span class="o">=</span> <span class="bp">None</span>

<span class="kn">from</span> <span class="nn">ubuntuone.platform.tools</span> <span class="kn">import</span> <span class="n">SyncDaemonTool</span>
<span class="kn">from</span> <span class="nn">ubuntuone.platform.credentials</span> <span class="kn">import</span> <span class="n">CredentialsManagementTool</span>
<span class="kn">from</span> <span class="nn">ubuntuone.couch</span> <span class="kn">import</span> <span class="n">auth</span>

<span class="kn">import</span> <span class="nn">accomplishments</span>
<span class="kn">from</span> <span class="nn">accomplishments</span> <span class="kn">import</span> <span class="n">exceptions</span>
<span class="kn">from</span> <span class="nn">accomplishments.daemon</span> <span class="kn">import</span> <span class="n">dbusapi</span>
<span class="kn">from</span> <span class="nn">accomplishments.util</span> <span class="kn">import</span> <span class="n">get_data_file</span><span class="p">,</span> <span class="n">SubprocessReturnCodeProtocol</span>
<span class="kn">from</span> <span class="nn">accomplishments.util.paths</span> <span class="kn">import</span> <span class="n">daemon_exec_dir</span><span class="p">,</span> <span class="n">media_dir</span><span class="p">,</span> <span class="n">module_dir1</span><span class="p">,</span> <span class="n">module_dir2</span><span class="p">,</span> <span class="n">installed</span><span class="p">,</span> <span class="n">locale_dir</span>

<span class="n">gettext</span><span class="o">.</span><span class="n">bindtextdomain</span><span class="p">(</span><span class="s">&#39;accomplishments-daemon&#39;</span><span class="p">,</span><span class="n">locale_dir</span><span class="p">)</span>
<span class="n">gettext</span><span class="o">.</span><span class="n">textdomain</span><span class="p">(</span><span class="s">&#39;accomplishments-daemon&#39;</span><span class="p">)</span>

<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;PYTHONPATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;$PYTHONPATH:.&quot;</span>
<span class="c"># The directories with accomplishment.* modules, that are being used by scripts,</span>
<span class="c"># may happen to be in a completelly different directory, if the daemon was</span>
<span class="c"># installed using a non-default prefix.</span>
<span class="k">if</span> <span class="n">installed</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;PYTHONPATH&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">module_dir1</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">module_dir2</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;PYTHONPATH&quot;</span><span class="p">]</span>

<span class="n">LOCAL_USERNAME</span> <span class="o">=</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>
<span class="n">SCRIPT_DELAY</span> <span class="o">=</span> <span class="mi">900</span>

<span class="c">#flags used for scripts_state</span>
<span class="n">NOT_RUNNING</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">RUNNING</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">NEEDS_RE_RUNNING</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c"># XXX the source code needs to be updated to use Twisted async calls better:</span>
<span class="c"># grep the source code for any *.asyncapi.* references, and if they return</span>
<span class="c"># deferreds, adjust them to use callbacks</span>
<div class="viewcode-block" id="AsyncAPI"><a class="viewcode-back" href="../../../index.html#accomplishments.daemon.api.AsyncAPI">[docs]</a><span class="k">class</span> <span class="nc">AsyncAPI</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class simply organizes all the Twisted calls into a single location</span>
<span class="sd">    for better readability and separation of concerns.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">run_a_subprocess</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Running subprocess command: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">command</span><span class="p">))</span>
        <span class="n">pprotocol</span> <span class="o">=</span> <span class="n">SubprocessReturnCodeProtocol</span><span class="p">()</span>
        <span class="n">reactor</span><span class="o">.</span><span class="n">spawnProcess</span><span class="p">(</span><span class="n">pprotocol</span><span class="p">,</span> <span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">command</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pprotocol</span><span class="o">.</span><span class="n">returnCodeDeferred</span>
    
    <span class="nd">@defer.inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">verify_ubuntu_one_account</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># check if this machine has an Ubuntu One account</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Check if this machine has an Ubuntu One account...&quot;</span><span class="p">)</span>

        <span class="n">tool</span> <span class="o">=</span> <span class="n">CredentialsManagementTool</span><span class="p">()</span>
        <span class="n">creds</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">tool</span><span class="o">.</span><span class="n">register</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">creds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;...Yes.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">has_u1</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">ubuntu_one_account_ready</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;...No.&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">u1auth_response</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">has_u1</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="c"># XXX let&#39;s rewrite this to use deferreds explicitly</span>
    <span class="nd">@defer.inlineCallbacks</span>
<div class="viewcode-block" id="AsyncAPI.register_trophy_dir"><a class="viewcode-back" href="../../../index.html#accomplishments.daemon.api.AsyncAPI.register_trophy_dir">[docs]</a>    <span class="k">def</span> <span class="nf">register_trophy_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trophydir</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates the Ubuntu One share for the trophydir and offers it to the</span>
<span class="sd">        server. Returns True if the folder was successfully shared, False if</span>
<span class="sd">        not.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timeid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Registering Ubuntu One share directory: &quot;</span> <span class="o">+</span> <span class="n">trophydir</span><span class="p">)</span>

        <span class="n">folder_list</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sd</span><span class="o">.</span><span class="n">get_folders</span><span class="p">()</span>
        <span class="n">folder_is_synced</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folder_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">folder</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">trophydir</span><span class="p">:</span>
                <span class="n">folder_is_synced</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder_is_synced</span><span class="p">:</span>
            <span class="c"># XXX let&#39;s breack this out into a separate sync&#39;ing method</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                <span class="s">&quot;...the &#39;</span><span class="si">%s</span><span class="s">&#39; folder is not synced with the Matrix&quot;</span> <span class="o">%</span> <span class="n">trophydir</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;...creating the share folder on Ubuntu One&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sd</span><span class="o">.</span><span class="n">create_folder</span><span class="p">(</span><span class="n">trophydir</span><span class="p">)</span>

            <span class="n">success_filter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">info</span><span class="p">:</span> <span class="n">info</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">trophydir</span>
            <span class="n">info</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sd</span><span class="o">.</span><span class="n">wait_for_signals</span><span class="p">(</span>
                <span class="n">signal_ok</span><span class="o">=</span><span class="s">&#39;FolderCreated&#39;</span><span class="p">,</span> <span class="n">success_filter</span><span class="o">=</span><span class="n">success_filter</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sd</span><span class="o">.</span><span class="n">offer_share</span><span class="p">(</span>
                <span class="n">trophydir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">matrix_username</span><span class="p">,</span> <span class="n">LOCAL_USERNAME</span> <span class="o">+</span> <span class="s">&quot; Trophies Folder&quot;</span>
                <span class="o">+</span> <span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="n">timeid</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="p">,</span> <span class="s">&quot;Modify&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                <span class="s">&quot;...share has been offered (&quot;</span> <span class="o">+</span> <span class="n">trophydir</span> <span class="o">+</span> <span class="s">&quot;&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">matrix_username</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">LOCAL_USERNAME</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;...the &#39;</span><span class="si">%s</span><span class="s">&#39; folder is already synced&quot;</span> <span class="o">%</span> <span class="n">trophydir</span><span class="p">)</span>
        <span class="c"># XXX put the following logic into a folders (plural) sharing method</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;... now checking whether it&#39;s shared&quot;</span><span class="p">)</span>
        <span class="n">shared_list</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sd</span><span class="o">.</span><span class="n">list_shared</span><span class="p">()</span>
        <span class="n">folder_is_shared</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">shared_to</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">share</span> <span class="ow">in</span> <span class="n">shared_list</span><span class="p">:</span>
            <span class="c"># XXX let&#39;s break this out into a separate share-tracking method</span>
            <span class="k">if</span> <span class="n">share</span><span class="p">[</span><span class="s">&quot;path&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">trophydir</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;...the folder is already shared.&quot;</span><span class="p">)</span>
                <span class="n">folder_is_shared</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="n">shared_to</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s"> (</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">share</span><span class="p">[</span><span class="s">&quot;other_visible_name&quot;</span><span class="p">],</span> <span class="n">share</span><span class="p">[</span><span class="s">&quot;other_username&quot;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">folder_is_shared</span><span class="p">:</span>
            <span class="c"># XXX let&#39;s break this out into a separate folder-sharing method</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;...the &#39;</span><span class="si">%s</span><span class="s">&#39; folder is not shared&quot;</span> <span class="o">%</span> <span class="n">trophydir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">sd</span><span class="o">.</span><span class="n">offer_share</span><span class="p">(</span>
                <span class="n">trophydir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">matrix_username</span><span class="p">,</span> <span class="n">LOCAL_USERNAME</span> <span class="o">+</span> <span class="s">&quot; Trophies Folder&quot;</span>
                <span class="o">+</span> <span class="s">&quot; (&quot;</span> <span class="o">+</span> <span class="n">timeid</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="p">,</span> <span class="s">&quot;Modify&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;...share has been offered (&quot;</span> <span class="o">+</span> <span class="n">trophydir</span> <span class="o">+</span> <span class="s">&quot;&quot;</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">matrix_username</span> <span class="o">+</span> <span class="s">&quot;, &quot;</span> <span class="o">+</span> <span class="n">LOCAL_USERNAME</span> <span class="o">+</span> <span class="s">&quot;)&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;...offered the share.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;The folder is shared, with: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">shared_to</span><span class="p">))</span>
            <span class="k">return</span>

    <span class="c"># XXX let&#39;s rewrite this to use deferreds explicitly</span></div>
    <span class="nd">@defer.inlineCallbacks</span>
    <span class="k">def</span> <span class="nf">run_scripts_for_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uid</span><span class="p">):</span>
        <span class="c"># The following avoids running multiple instances of this function,</span>
        <span class="c"># which might get very messy and cause a lot of trouble. Simulatnously</span>
        <span class="c"># run scripts would be the case if user recieves several .asc files</span>
        <span class="c"># within a short time, the scripts take extraordinary time to run,</span>
        <span class="c"># or for various other reasons.</span>
        <span class="c"># NOTE: detailed explanation of scripts_state mechanism is included</span>
        <span class="c"># near it&#39;s initialisation in Accomplishments.__init__(...).</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">scripts_state</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">scripts_state</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="ow">is</span> <span class="n">RUNNING</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Aborting running scripts, execution already in progress. Will re-do this when current run ends.&quot;</span><span class="p">)</span>
                <span class="c"># scripts are already being run for that user, but since something</span>
                <span class="c"># called that function, maybe we need to re-run them because</span>
                <span class="c"># something has changed since last call, so let&#39;s schedule the</span>
                <span class="c"># re-running immidiatelly after finishing this run, and abort</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">scripts_state</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">NEEDS_RE_RUNNING</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">scripts_state</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="ow">is</span> <span class="n">NEEDS_RE_RUNNING</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Aborting running scripts, execution already in progress. Re-runing scripts has already been scheduled.&quot;</span><span class="p">)</span>
                <span class="c"># already scheduled, so just aborting</span>
                <span class="k">return</span>
        <span class="c"># if above conditions failed, that means the scripts are not being run</span>
        <span class="c"># this user, so we can continue normally, marking the scripts as running...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">scripts_state</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">RUNNING</span>
            
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;--- Starting Running Scripts ---&quot;</span><span class="p">)</span>
        <span class="n">timestart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">scriptrunner_start</span><span class="p">()</span>

        <span class="c"># Is the user currently logged in and running a gnome session?</span>
        <span class="c"># XXX use deferToThread</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwuid</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span><span class="o">.</span><span class="n">pw_name</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c"># XXX since we&#39;re using Twisted, let&#39;s use it here too and use the</span>
            <span class="c"># deferred-returning call</span>
            <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span>
                <span class="p">[</span><span class="s">&quot;pgrep&quot;</span><span class="p">,</span> <span class="s">&quot;-u&quot;</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="s">&quot;gnome-session&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span><span class="p">:</span>
            <span class="c"># user does not have gnome-session running or isn&#39;t logged in at</span>
            <span class="c"># all</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;No gnome-session process for user </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">username</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">scripts_state</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOT_RUNNING</span> <span class="c">#unmarking to avoid dead-lock</span>
            <span class="k">return</span>
        <span class="c"># XXX this is a blocking call and can&#39;t be here if we want to take</span>
        <span class="c"># advantage of deferreds; instead, rewrite this so that the blocking</span>
        <span class="c"># call occurs in a separate thread (e.g., deferToThread)</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;/proc/</span><span class="si">%s</span><span class="s">/environ&quot;</span> <span class="o">%</span> <span class="n">proc</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">envars</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                <span class="p">[</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fp</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()])</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
            <span class="c"># user does not have gnome-session running or isn&#39;t logged in at</span>
            <span class="c"># all</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;No gnome-session environment for user </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">username</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">scripts_state</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOT_RUNNING</span> <span class="c">#unmarking to avoid dead-lock</span>
            <span class="k">return</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c"># XXX use deferToThread</span>
        <span class="n">os</span><span class="o">.</span><span class="n">seteuid</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>

        <span class="n">required_envars</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;DBUS_SESSION_BUS_ADDRESS&#39;</span><span class="p">]</span>
        <span class="n">env</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span><span class="n">kv</span> <span class="k">for</span> <span class="n">kv</span> <span class="ow">in</span> <span class="n">envars</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">kv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">required_envars</span><span class="p">])</span>
        <span class="c"># XXX use deferToThread</span>
        <span class="n">oldenviron</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="c"># XXX note that for many of these deferredToThread changes, we can put</span>
        <span class="c"># them all in a DeferredList and once they&#39;re all done and we have the</span>
        <span class="c"># results for all of them, a callback can be fired to continue.</span>

        <span class="c"># XXX this next call, a DBus check, happens in the middle of this</span>
        <span class="c"># method; it would be better if this check was done at a higher level,</span>
        <span class="c"># for instance, where this class is initiated: if the daemon isn&#39;t</span>
        <span class="c"># registered at the time of instantiation, simply abort then instead of</span>
        <span class="c"># making all the way here and then aborting. (Note that moving this</span>
        <span class="c"># check to that location will also eliminate an obvious circular</span>
        <span class="c"># import.)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dbusapi</span><span class="o">.</span><span class="n">daemon_is_registered</span><span class="p">():</span>
            <span class="k">return</span>

        <span class="c"># XXX all parent calls should be refactored out of the AsyncAPI class</span>
        <span class="c"># to keep the code cleaner and the logic more limited to one particular</span>
        <span class="c"># task</span>
        <span class="n">accoms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">list_unlocked_not_completed</span><span class="p">()</span>
                
        <span class="n">totalscripts</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">accoms</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Need to run (</span><span class="si">%d</span><span class="s">) scripts:&quot;</span> <span class="o">%</span> <span class="n">totalscripts</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">accoms</span><span class="p">))</span>

        <span class="n">scriptcount</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">accomID</span> <span class="ow">in</span> <span class="n">accoms</span><span class="p">:</span>
            <span class="n">scriptpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get_acc_script_path</span><span class="p">(</span><span class="n">accomID</span><span class="p">)</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">scriptcount</span><span class="p">,</span> <span class="n">totalscripts</span><span class="p">,</span> <span class="n">scriptpath</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">exitcode</span> <span class="o">=</span> <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_a_subprocess</span><span class="p">([</span><span class="n">scriptpath</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">exitcode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">accomplish</span><span class="p">(</span><span class="n">accomID</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;...Accomplished&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">exitcode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;...Not Accomplished&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">exitcode</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;....Error&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">exitcode</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;...Could not get extra-information&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;...Error code </span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">exitcode</span><span class="p">)</span>
            <span class="n">scriptcount</span> <span class="o">=</span> <span class="n">scriptcount</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">os</span><span class="o">.</span><span class="n">environ</span> <span class="o">=</span> <span class="n">oldenviron</span>

        <span class="c"># XXX eventually the code in this method will be rewritten using</span>
        <span class="c"># deferreds; as such, we&#39;re going to have to be more clever regarding</span>
        <span class="c"># timing things...</span>
        <span class="n">timeend</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">timefinal</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">timeend</span> <span class="o">-</span> <span class="n">timestart</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="s">&quot;--- Completed Running Scripts in </span><span class="si">%.2f</span><span class="s"> seconds---&quot;</span> <span class="o">%</span> <span class="n">timefinal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">scriptrunner_finish</span><span class="p">()</span>
        
        <span class="c"># checking whether this function was called while script execution was in progress...</span>
        <span class="n">rerun</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">scripts_state</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="ow">is</span> <span class="n">NEEDS_RE_RUNNING</span><span class="p">)</span>
        <span class="c"># unsetting the lock</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">scripts_state</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span> <span class="o">=</span> <span class="n">NOT_RUNNING</span>
        <span class="c"># re-running scripts if needed</span>
        <span class="k">if</span> <span class="n">rerun</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Re-running scripts as intended...&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_scripts_for_user</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="Accomplishments"><a class="viewcode-back" href="../../../index.html#accomplishments.daemon.api.Accomplishments">[docs]</a><span class="k">class</span> <span class="nc">Accomplishments</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The main accomplishments daemon.</span>

<span class="sd">    No D-Bus required, so that it can be used for testing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">show_notifications</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accomplishments_installpaths</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trophies_path</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_u1</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_verif</span> <span class="o">=</span> <span class="bp">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">matrix_username</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">lang</span> <span class="o">=</span> <span class="n">locale</span><span class="o">.</span><span class="n">getdefaultlocale</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c"># use this to override the language for testing</span>
        <span class="c">#self.lang = &quot;pt_BR&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accomlangs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">service</span> <span class="o">=</span> <span class="n">service</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asyncapi</span> <span class="o">=</span> <span class="n">AsyncAPI</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c"># The following dictionary represents state of scripts.</span>
        <span class="c"># It&#39;s a dictionary and not a single variable, because scripts may be run</span>
        <span class="c"># for each user independently. For each user, the state can be either</span>
        <span class="c"># RUNNING, NOT_RUNNING or NEEDS_RE_RUNNING. If an entry for a</span>
        <span class="c"># particular UID does not exist, it should be treated as NOT_RUNNING.</span>
        <span class="c"># The use of this flag is to aviod running several instances of </span>
        <span class="c"># run_scripts_for_user, which might result in undefined, troubleful</span>
        <span class="c"># behavior. The flags are NOT_RUNNING by default, and are set to</span>
        <span class="c"># RUNNING when the run_scripts_for_user starts. However, if it has been</span>
        <span class="c"># already set to RUNNING, the function will abort, and will instead set the</span>
        <span class="c"># flag to NEEDS_RE_RUNNING, in order to mark that the scripts have to</span>
        <span class="c"># be run once more, because something might have changed since we run</span>
        <span class="c"># them the last time (as the run_scripts_for_user was called while </span>
        <span class="c"># scripts were being executed). Setting the flag to NEEDS_RE_RUNNING </span>
        <span class="c"># will cause run_scripts_for_user to redo everything after having</span>
        <span class="c"># finished it&#39;s current task in progress. Otherwise it will eventually</span>
        <span class="c"># set the flag back to NOT_RUNNING.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scripts_state</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c"># create config / data dirs if they don&#39;t exist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir_config</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">xdg</span><span class="o">.</span><span class="n">BaseDirectory</span><span class="o">.</span><span class="n">xdg_config_home</span><span class="p">,</span> <span class="s">&quot;accomplishments&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir_data</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">xdg</span><span class="o">.</span><span class="n">BaseDirectory</span><span class="o">.</span><span class="n">xdg_data_home</span><span class="p">,</span> <span class="s">&quot;accomplishments&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dir_cache</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">xdg</span><span class="o">.</span><span class="n">BaseDirectory</span><span class="o">.</span><span class="n">xdg_cache_home</span><span class="p">,</span> <span class="s">&quot;accomplishments&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_config</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_config</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_data</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_cache</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_cache</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dir_autostart</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">xdg</span><span class="o">.</span><span class="n">BaseDirectory</span><span class="o">.</span><span class="n">xdg_config_home</span><span class="p">,</span> <span class="s">&quot;autostart&quot;</span><span class="p">)</span>

        <span class="k">print</span> <span class="nb">str</span><span class="p">(</span><span class="s">&quot;------------------- Ubuntu Accomplishments Daemon &quot;</span>
            <span class="s">&quot;- &quot;</span><span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span> <span class="o">+</span><span class="s">&quot; -------------------&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_load_config_file</span><span class="p">()</span>

        <span class="k">print</span> <span class="nb">str</span><span class="p">(</span><span class="s">&quot;Accomplishments install paths: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">accomplishments_installpaths</span><span class="p">)</span>
        <span class="k">print</span> <span class="nb">str</span><span class="p">(</span><span class="s">&quot;Trophies path: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">trophies_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">show_notifications</span> <span class="o">=</span> <span class="n">show_notifications</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Connecting to Ubuntu One&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sd</span> <span class="o">=</span> <span class="n">SyncDaemonTool</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reload_accom_database</span><span class="p">()</span>
		
        <span class="c"># XXX this wait-until thing should go away; it should be replaced by a</span>
        <span class="c"># deferred-returning function that has a callback which fires off</span>
        <span class="c"># generate_all_trophis and schedule_run_scripts...</span>
        <span class="c">#self._wait_until_a_sig_file_arrives()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sd</span><span class="o">.</span><span class="n">connect_signal</span><span class="p">(</span><span class="s">&quot;DownloadFinished&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_recieved_asc_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_all_trophy_icons</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">get_media_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">media_file_name</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;MEDIA_FILE_NAME:&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">media_file_name</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;MEDIA_DIR:&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">media_dir</span><span class="p">)</span>
        <span class="c">#media_filename = get_data_file(media_dir.split, &#39;%s&#39; % (media_file_name,))</span>
        <span class="n">media_filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">media_dir</span><span class="p">,</span> <span class="n">media_file_name</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;MEDIA_FILENAME:&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">media_filename</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">media_filename</span><span class="p">):</span>
            <span class="n">media_filename</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">final</span> <span class="o">=</span> <span class="s">&quot;file:///&quot;</span> <span class="o">+</span> <span class="n">media_filename</span>
        <span class="k">return</span> <span class="n">final</span>

    <span class="k">def</span> <span class="nf">_create_all_trophy_icons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Iterate through each of the accomplishments on the system</span>
<span class="sd">        and generate all of the required icons that we provide to</span>
<span class="sd">        clients.&quot;&quot;&quot;</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_collections</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">col_imagespath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s">&#39;base-path&#39;</span><span class="p">],</span><span class="s">&quot;trophyimages&quot;</span><span class="p">)</span>
            <span class="n">cache_trophyimagespath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dir_cache</span><span class="p">,</span> <span class="s">&quot;trophyimages&quot;</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
            <span class="n">lock_image_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">media_dir</span><span class="p">,</span> <span class="s">&quot;lock.png&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">cache_trophyimagespath</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">cache_trophyimagespath</span><span class="p">)</span>
            
            <span class="c"># First, delete all cached images:</span>
            <span class="n">cachedlist</span><span class="o">=</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">cache_trophyimagespath</span> <span class="o">+</span> <span class="s">&quot;/*&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cachedlist</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            
            <span class="n">mark</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">lock_image_path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">col_imagespath</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">im</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
                        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cache_trophyimagespath</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                        <span class="n">filecore</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">filetype</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

                        <span class="n">im</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                        
                        <span class="c"># Opacity set to 1.0 until we figure out a better way of</span>
                        <span class="c"># showing opportunities</span>
                        <span class="n">reduced</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_reduced_opacity_trophy_icon</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
                        <span class="n">reduced</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filecore</span> <span class="o">+</span> <span class="s">&quot;-opportunity&quot;</span> <span class="o">+</span> <span class="n">filetype</span><span class="p">)</span>

                        <span class="k">if</span> <span class="n">im</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s">&#39;RGBA&#39;</span><span class="p">:</span>
                            <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s">&#39;RGBA&#39;</span><span class="p">)</span>
                        <span class="n">layer</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s">&#39;RGBA&#39;</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
                        <span class="n">position</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="n">im</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">mark</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">im</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mark</span><span class="o">.</span><span class="n">size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">layer</span><span class="o">.</span><span class="n">paste</span><span class="p">(</span><span class="n">mark</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
                        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">composite</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">reduced</span><span class="p">,</span> <span class="n">layer</span><span class="p">)</span>
                        <span class="n">img</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filecore</span> <span class="o">+</span> <span class="s">&quot;-locked&quot;</span> <span class="o">+</span> <span class="n">filetype</span><span class="p">)</span>
                        
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="p">(</span><span class="n">msg</span><span class="p">):</span>
                        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            

    <span class="k">def</span> <span class="nf">_create_reduced_opacity_trophy_icon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">,</span> <span class="n">opacity</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns an image with reduced opacity.&quot;&quot;&quot;</span>
        
        <span class="k">assert</span> <span class="n">opacity</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">opacity</span> <span class="o">&lt;=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">im</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="s">&#39;RGBA&#39;</span><span class="p">:</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s">&#39;RGBA&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">ImageEnhance</span><span class="o">.</span><span class="n">Brightness</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span><span class="o">.</span><span class="n">enhance</span><span class="p">(</span><span class="n">opacity</span><span class="p">)</span>
        <span class="n">im</span><span class="o">.</span><span class="n">putalpha</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">im</span>

<div class="viewcode-block" id="Accomplishments.get_config_value"><a class="viewcode-back" href="../../../index.html#accomplishments.daemon.api.Accomplishments.get_config_value">[docs]</a>    <span class="k">def</span> <span class="nf">get_config_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a configuration value from the .accomplishments file&quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="s">&quot;Returning configuration values for: </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
        <span class="n">homedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;HOME&quot;</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
        <span class="n">cfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_config</span> <span class="o">+</span> <span class="s">&quot;/.accomplishments&quot;</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cfile</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">section</span> <span class="o">==</span> <span class="s">&quot;config&quot;</span> <span class="ow">and</span> <span class="n">item</span> <span class="o">==</span> <span class="s">&quot;has_u1&quot;</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">item</span>
            <span class="k">elif</span> <span class="n">section</span> <span class="o">==</span> <span class="s">&quot;config&quot;</span> <span class="ow">and</span> <span class="n">item</span> <span class="o">==</span> <span class="s">&quot;has_verif&quot;</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">item</span>
            <span class="k">elif</span> <span class="n">section</span> <span class="o">==</span> <span class="s">&quot;config&quot;</span> <span class="ow">and</span> <span class="n">item</span> <span class="o">==</span> <span class="s">&quot;daemon_sessionstart&quot;</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">item</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">item</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;NoOption&quot;</span>
</div>
    <span class="k">def</span> <span class="nf">verify_ubuntu_one_account</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">asyncapi</span><span class="o">.</span><span class="n">verify_ubuntu_one_account</span><span class="p">()</span>

<div class="viewcode-block" id="Accomplishments.write_config_file_item"><a class="viewcode-back" href="../../../index.html#accomplishments.daemon.api.Accomplishments.write_config_file_item">[docs]</a>    <span class="k">def</span> <span class="nf">write_config_file_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">section</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set a configuration value in the .accomplishments file&quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="s">&quot;Set configuration file value in &#39;</span><span class="si">%s</span><span class="s">&#39;: </span><span class="si">%s</span><span class="s"> = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span>
            <span class="n">value</span><span class="p">))</span>
        <span class="n">homedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;HOME&quot;</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
        <span class="n">cfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_config</span> <span class="o">+</span> <span class="s">&quot;/.accomplishments&quot;</span>

        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">section</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="c"># Writing our configuration file to &#39;example.cfg&#39;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cfile</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">configfile</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">configfile</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_load_config_file</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_write_config_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the values held in various configuration state variables</span>
<span class="sd">        to the main daemon configuration file, which should be located</span>
<span class="sd">        in ~/.config/accomplishments/.accomplishments.&quot;&quot;&quot;</span>
        
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Writing the configuration file&quot;</span><span class="p">)</span>
        <span class="n">homedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&quot;HOME&quot;</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
        <span class="n">cfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dir_config</span> <span class="o">+</span> <span class="s">&quot;/.accomplishments&quot;</span>

        <span class="c"># The following sets self.has_u1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify_ubuntu_one_account</span><span class="p">()</span>
        
        <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s">&#39;config&#39;</span><span class="p">)</span>

        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="s">&#39;has_u1&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_u1</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="s">&#39;has_verif&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_verif</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="s">&#39;accompath&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">accomplishments_installpaths</span><span class="p">)</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="s">&#39;trophypath&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trophies_path</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cfile</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">configfile</span><span class="p">:</span>
        <span class="c"># Writing our configuration file to &#39;example.cfg&#39;</span>
            <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">configfile</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;...done.&quot;</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">_load_config_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load the main configuration file for the daemon. This should be</span>
<span class="sd">        located in ~/.config/accomplishments/.accomplishments and it provides</span>
<span class="sd">        a ConfigParser INI-style list of values.&quot;&quot;&quot;</span>
        
        <span class="n">homedir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;HOME&quot;</span><span class="p">]</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
        <span class="n">cfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_config</span><span class="p">,</span> <span class="s">&quot;.accomplishments&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cfile</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Loading configuration file: &quot;</span> <span class="o">+</span> <span class="n">cfile</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="s">&#39;accompath&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">accomplishments_installpaths</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="s">&#39;accompath&#39;</span><span class="p">)</span>
                <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="s">&quot;...setting accomplishments install paths to: &quot;</span>
                    <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">accomplishments_installpaths</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="s">&#39;trophypath&#39;</span><span class="p">):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                    <span class="s">&quot;...setting trophies path to: &quot;</span>
                    <span class="o">+</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="s">&#39;trophypath&#39;</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trophies_path</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="s">&#39;trophypath&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="s">&#39;has_u1&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">has_u1</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="s">&#39;has_u1&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="s">&#39;has_verif&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">has_verif</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">getboolean</span><span class="p">(</span><span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="s">&#39;has_verif&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&#39;config&#39;</span><span class="p">,</span><span class="s">&#39;staging&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;config&#39;</span><span class="p">,</span> <span class="s">&#39;staging&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matrix_username</span> <span class="o">=</span> <span class="s">&quot;openiduser204307&quot;</span> <span class="c"># staging ID</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">matrix_username</span> <span class="o">=</span> <span class="s">&quot;openiduser155707&quot;</span> <span class="c"># production ID</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c"># setting accomplishments path to the system default</span>
            <span class="n">home</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s">&quot;~/accomplishments&quot;</span><span class="p">)</span>
            <span class="n">accompath</span> <span class="o">=</span> <span class="n">home</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="s">&quot;/usr/share/accomplishments&quot;</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Configuration file not found...creating it!&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">has_verif</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">accomplishments_installpaths</span> <span class="o">=</span> <span class="n">accompath</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
                <span class="s">&quot;...setting accomplishments install paths to: &quot;</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">accomplishments_installpaths</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;You can set this to different locations in your config file.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trophies_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_data</span><span class="p">,</span> <span class="s">&quot;trophies&quot;</span><span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;...setting trophies path to: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">trophies_path</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trophies_path</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trophies_path</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_write_config_file</span><span class="p">()</span>

<div class="viewcode-block" id="Accomplishments.get_all_extra_information"><a class="viewcode-back" href="../../../index.html#accomplishments.daemon.api.Accomplishments.get_all_extra_information">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_extra_information</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dictionary of all information for the accomplishments</span>
<span class="sd">        to authticate. Returns {application, needs-information, label,</span>
<span class="sd">        description, value}.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># get a list of all accomplishments</span>
        <span class="n">accomplishments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_accomplishments</span><span class="p">()</span>
        
        <span class="n">infoneeded</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c"># and prepend the path to the directory, where all extra-information </span>
        <span class="c"># is stored [like: ~/.local/share/accomplishments/trophies/.extrainformation/]</span>
        <span class="n">trophyextrainfo</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trophies_path</span><span class="p">,</span> <span class="s">&quot;.extrainformation/&quot;</span><span class="p">)</span>

        <span class="c"># in case this directory does not exist, create it </span>
        <span class="c"># this may happen if user hadn&#39;t yet set any ExtraInformation field</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">trophyextrainfo</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">trophyextrainfo</span><span class="p">)</span>

        <span class="c"># now, for each accomplishment file that is available...</span>
        <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">accomplishments</span><span class="p">:</span>
            <span class="c"># get the path to the directory of accomplishments set&#39;s</span>
            <span class="c"># &quot;extrainformation&quot; dir - it is useful, because it contains</span>
            <span class="c"># translated labels and descriptions</span>
            <span class="n">accomextrainfo</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">acc</span><span class="p">][</span><span class="s">&#39;base-path&#39;</span><span class="p">]</span>
                <span class="p">,</span> <span class="s">&quot;extrainformation&quot;</span><span class="p">)</span>
                
            <span class="c"># a temporary variable, representing a single entry of the list this function returns</span>
            <span class="n">d</span> <span class="o">=</span> <span class="p">{}</span>
            
            <span class="c"># Get collection name from accomOD</span>
            <span class="n">collection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coll_from_accomID</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
            
            <span class="n">ei</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_needs_info</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ei</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span>
            
                <span class="c"># For each needed piece of information:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ei</span><span class="p">:</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">collection</span><span class="p">][</span><span class="s">&#39;extra-information&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;label&#39;</span><span class="p">]</span>
                    <span class="n">desc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">collection</span><span class="p">][</span><span class="s">&#39;extra-information&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s">&#39;description&#39;</span><span class="p">]</span>
                    <span class="c"># we also need to know whether user has already set this item&#39;s value.</span>
                    <span class="c"># to do this, simply check whether trophies/.extrainformation/&lt;item&gt; file exists.</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">valuefile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">trophyextrainfo</span><span class="p">,</span><span class="n">i</span><span class="p">))</span>
                        <span class="c"># if we got here without an exception, it means that the file exists</span>
                        <span class="c"># so, we can read it&#39;s value</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">valuefile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span> <span class="c"># get rid of the tailing newline</span>
                        <span class="c"># and build up the dictionary of all data for a single ExtraInformation field</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s">&quot;collection&quot;</span> <span class="p">:</span> <span class="n">collection</span><span class="p">,</span>
                            <span class="s">&quot;needs-information&quot;</span> <span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                            <span class="s">&quot;label&quot;</span> <span class="p">:</span> <span class="n">label</span><span class="p">,</span>
                            <span class="s">&quot;description&quot;</span> <span class="p">:</span> <span class="n">desc</span><span class="p">,</span>
                            <span class="s">&quot;value&quot;</span> <span class="p">:</span> <span class="n">value</span><span class="p">}</span>
                    <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="c"># we got an exception, so it seems that the file is not present - we&#39;ll use &quot;&quot; as the value, to indicate that it&#39;s empty</span>
                        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s">&quot;collection&quot;</span> <span class="p">:</span> <span class="n">collection</span><span class="p">,</span>
                            <span class="s">&quot;needs-information&quot;</span> <span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                            <span class="s">&quot;label&quot;</span> <span class="p">:</span> <span class="n">label</span><span class="p">,</span>
                            <span class="s">&quot;description&quot;</span> <span class="p">:</span> <span class="n">desc</span><span class="p">,</span>
                            <span class="s">&quot;value&quot;</span> <span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">}</span>

                    <span class="c"># since the collected all data related to this particular ExtraInformation field, append it to the list</span>
                    <span class="n">infoneeded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>

        <span class="c"># at this moment the infoneeded list will be ready, but full of duplicates,</span>
        <span class="c"># for the items have been added multiple times, if they are mentioned in more then one .accomplishment file</span>
        <span class="n">final</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">infoneeded</span><span class="p">:</span>   <span class="c">#for each item in the original list...</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">final</span><span class="p">:</span> <span class="c">#...add it to the outputted list only if it hadn&#39;t been added yet.</span>
                <span class="n">final</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">final</span>
</div>
<div class="viewcode-block" id="Accomplishments.get_all_extra_information_required"><a class="viewcode-back" href="../../../index.html#accomplishments.daemon.api.Accomplishments.get_all_extra_information_required">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_extra_information_required</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return a dictionary of all information required for the accomplishments</span>
<span class="sd">        to authticate that has not been set yet. Returns {application,</span>
<span class="sd">        needs-information, label, description} Returns only these, which value is not set.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c">#fetch a full list of ExtraInformation</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_extra_information</span><span class="p">()</span>
        <span class="c">#now we need to unsort the data just to output these entries, that have value == &quot;&quot;</span>
        <span class="c">#this way we can return a list of ExtraInformation fields, that have not been write_config_file_item</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span> <span class="c">#for each ExtraInformation in the full list</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]:</span> <span class="c">#if the value string is empty, so this ExtraInformation field have not been yet set</span>
                <span class="n">i</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;value&#39;</span><span class="p">)</span> <span class="c">#remove the &#39;value&#39; field (it&#39;s empty anyway)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="c">#add this entry to the resulting list</span>
            <span class="c">#do not add these fields, that have some value</span>
            
        <span class="k">return</span> <span class="n">result</span>
</div>
    <span class="k">def</span> <span class="nf">run_scripts_for_all_active_users</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">uid</span> <span class="ow">in</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">pw_uid</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwall</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">pw_dir</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;/home/&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">x</span><span class="o">.</span><span class="n">pw_shell</span> <span class="o">!=</span> <span class="s">&#39;/bin/false&#39;</span><span class="p">]:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">seteuid</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">asyncapi</span><span class="o">.</span><span class="n">run_scripts_for_user</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run_scripts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run_by_client</span><span class="p">):</span>
        <span class="n">uid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">uid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Run scripts for all active users&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_scripts_for_all_active_users</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Run scripts for user&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">asyncapi</span><span class="o">.</span><span class="n">run_scripts_for_user</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>

<div class="viewcode-block" id="Accomplishments.create_extra_information_file"><a class="viewcode-back" href="../../../index.html#accomplishments.daemon.api.Accomplishments.create_extra_information_file">[docs]</a>    <span class="k">def</span> <span class="nf">create_extra_information_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Does exactly the same as write_extra_information_file(), but it does not</span>
<span class="sd">           overwrite any existing data&quot;&quot;&quot;</span>
           
        <span class="c"># XXX this should be removed as we are using write_extra_information_file</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="s">&quot;Creating Extra Information file: </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
        <span class="n">extrainfodir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trophies_path</span><span class="p">,</span> <span class="s">&quot;.extrainformation/&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">extrainfodir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">extrainfodir</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extrainfodir</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span> <span class="c">#if the file already exists, do not overwrite it</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extrainfodir</span><span class="p">,</span> <span class="n">item</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</div>
    <span class="k">def</span> <span class="nf">_process_recieved_asc_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Trophy signature recieved...&quot;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Processing signature: &quot;</span> <span class="o">+</span> <span class="n">path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trophies_path</span><span class="p">)</span> <span class="ow">and</span> <span class="n">path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;.asc&quot;</span><span class="p">):</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_is_asc_correct</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;WARNING: invalid .asc signature recieved from the server!&quot;</span><span class="p">)</span>
        
            <span class="k">if</span> <span class="n">valid</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">accomID</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trophies_path</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">11</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">trophy_received</span><span class="p">(</span><span class="n">accomID</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_display_accomplished_bubble</span><span class="p">(</span><span class="n">accomID</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_display_unlocked_bubble</span><span class="p">(</span><span class="n">accomID</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_mark_as_completed</span><span class="p">(</span><span class="n">accomID</span><span class="p">)</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">run_scripts</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">write_extra_information_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span>
            <span class="s">&quot;Saving Extra Information file: </span><span class="si">%s</span><span class="s">, </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
        <span class="n">extrainfodir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trophies_path</span><span class="p">,</span> <span class="s">&quot;.extrainformation/&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">extrainfodir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">extrainfodir</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">data</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extrainfodir</span><span class="p">,</span> <span class="n">item</span><span class="p">),</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="c">#will trunkate the file, in case it exist</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="c">#file would be empty, remove it instead</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extrainfodir</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
            
<div class="viewcode-block" id="Accomplishments.invalidate_extra_information"><a class="viewcode-back" href="../../../index.html#accomplishments.daemon.api.Accomplishments.invalidate_extra_information">[docs]</a>    <span class="k">def</span> <span class="nf">invalidate_extra_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">extrainfo</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This used to remove all trophies, but since it is essential to</span>
<span class="sd">        preserve them, this is no longer the case</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>
            </div>
<div class="viewcode-block" id="Accomplishments.get_extra_information"><a class="viewcode-back" href="../../../index.html#accomplishments.daemon.api.Accomplishments.get_extra_information">[docs]</a>    <span class="k">def</span> <span class="nf">get_extra_information</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coll</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is particularly sensitive.</span>
<span class="sd">        It is used by all global accomplishment scripts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">extrainfopath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trophies_path</span><span class="p">,</span> <span class="s">&quot;.extrainformation/&quot;</span><span class="p">)</span>
        <span class="n">authfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extrainfopath</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_collection_exists</span><span class="p">(</span><span class="n">coll</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;No such collection:&quot;</span> <span class="o">+</span> <span class="n">coll</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        
        <span class="n">label</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">coll</span><span class="p">][</span><span class="s">&#39;extra-information&#39;</span><span class="p">][</span><span class="n">item</span><span class="p">][</span><span class="s">&#39;label&#39;</span><span class="p">]</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">authfile</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
            <span class="n">final</span> <span class="o">=</span> <span class="p">[{</span><span class="n">item</span> <span class="p">:</span> <span class="n">data</span><span class="p">,</span> <span class="s">&quot;label&quot;</span> <span class="p">:</span> <span class="n">label</span><span class="p">}]</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c">#print &quot;No data.&quot;</span>
            <span class="n">final</span> <span class="o">=</span> <span class="p">[{</span><span class="n">item</span> <span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;label&quot;</span> <span class="p">:</span> <span class="s">&quot;&quot;</span><span class="p">}]</span>
        <span class="k">return</span> <span class="n">final</span>
		
    <span class="c"># =================================================================</span>
        </div>
    <span class="k">def</span> <span class="nf">reload_accom_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    
    <span class="c"># First, clear the database.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c"># Get the list of all paths where accomplishments may be</span>
        <span class="c"># installed...</span>
        <span class="n">installpaths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">accomplishments_installpaths</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">installpath</span> <span class="ow">in</span> <span class="n">installpaths</span><span class="p">:</span>
            <span class="c"># Look for all accomplishment collections in this path</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">installpath</span><span class="p">,</span><span class="s">&#39;accomplishments&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">continue</span>
            
            <span class="n">collections</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">collection</span> <span class="ow">in</span> <span class="n">collections</span><span class="p">:</span>
                <span class="c"># For each collection...</span>
                <span class="k">if</span> <span class="n">collection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">:</span>
                    <span class="c"># This collection has already been loaded from another install path!</span>
                    <span class="k">continue</span>
                
                <span class="n">collpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">collection</span><span class="p">)</span>
                <span class="n">aboutpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">collpath</span><span class="p">,</span><span class="s">&#39;ABOUT&#39;</span><span class="p">)</span>
                
                <span class="c"># Load data from ABOUT file</span>
                <span class="n">cfg</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
                <span class="n">cfg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">aboutpath</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;general&quot;</span><span class="p">,</span><span class="s">&quot;langdefault&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;general&quot;</span><span class="p">,</span><span class="s">&quot;name&quot;</span><span class="p">)):</span>
                    <span class="k">print</span> <span class="n">aboutpath</span>
                    <span class="k">raise</span> <span class="ne">LookupError</span><span class="p">(</span><span class="s">&quot;Accomplishment collection with invalid ABOUT file &quot;</span><span class="p">)</span>
                
                <span class="n">langdefault</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;general&quot;</span><span class="p">,</span><span class="s">&quot;langdefault&quot;</span><span class="p">)</span>
                <span class="n">collectionname</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;general&quot;</span><span class="p">,</span><span class="s">&quot;name&quot;</span><span class="p">)</span>
                
                <span class="n">collauthors</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                <span class="n">collcategories</span> <span class="o">=</span> <span class="p">{}</span>
                
                <span class="n">langdefaultpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">collpath</span><span class="p">,</span><span class="n">langdefault</span><span class="p">)</span>
                <span class="n">setsslist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">langdefaultpath</span><span class="p">)</span>
                <span class="n">accno</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">accomset</span> <span class="ow">in</span> <span class="n">setsslist</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">accomset</span><span class="p">[</span><span class="o">-</span><span class="mi">15</span><span class="p">:]</span> <span class="o">==</span> <span class="s">&#39;.accomplishment&#39;</span><span class="p">:</span>
                        <span class="c"># this is an ungroped accomplishment file</span>
                        <span class="n">accompath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">langdefaultpath</span><span class="p">,</span><span class="n">accomset</span><span class="p">)</span>
                        <span class="n">accomcfg</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
                        <span class="c"># check if there is a translated version...</span>
                        <span class="n">translatedpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">collpath</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lang</span><span class="p">),</span><span class="n">accomset</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">translatedpath</span><span class="p">):</span>
                            <span class="c"># yes, so use the translated file</span>
                            <span class="n">accomcfg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">translatedpath</span><span class="p">)</span>
                            <span class="n">langused</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c"># no. maybe there is a shorter language code?</span>
                            <span class="n">translatedpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">collpath</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span><span class="n">accomset</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">translatedpath</span><span class="p">):</span>
                                <span class="n">accomcfg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">translatedpath</span><span class="p">)</span>
                                <span class="n">langused</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c"># no. fallback to default one</span>
                                <span class="n">accomcfg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">accompath</span><span class="p">)</span>
                                <span class="n">langused</span> <span class="o">=</span> <span class="n">langdefault</span>
                        <span class="n">accomdata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">accomcfg</span><span class="o">.</span><span class="n">_sections</span><span class="p">[</span><span class="s">&quot;accomplishment&quot;</span><span class="p">])</span>
                        <span class="n">accomID</span> <span class="o">=</span> <span class="n">collection</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">accomset</span><span class="p">[:</span><span class="o">-</span><span class="mi">15</span><span class="p">]</span>
                        <span class="k">if</span> <span class="s">&#39;author&#39;</span> <span class="ow">in</span> <span class="n">accomdata</span><span class="p">:</span>
                            <span class="n">collauthors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;author&#39;</span><span class="p">])</span>
                        <span class="k">del</span> <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;__name__&#39;</span><span class="p">]</span>
                        <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
                        <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;collection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collection</span>
                        <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;accomplishment&quot;</span>
                        <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;lang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">langused</span>
                        <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;base-path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collpath</span>
                        <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;script-path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">installpath</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;scripts&#39;</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span><span class="n">accomset</span><span class="p">[:</span><span class="o">-</span><span class="mi">15</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;.py&quot;</span><span class="p">)))</span>
                        <span class="k">if</span> <span class="s">&#39;category&#39;</span> <span class="ow">in</span> <span class="n">accomdata</span><span class="p">:</span>
                            <span class="n">cats</span> <span class="o">=</span> <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span>
                            <span class="n">categories</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">cats</span><span class="p">:</span>
                                <span class="n">catsplitted</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span>
                                <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;categories&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>
                                <span class="k">if</span> <span class="n">catsplitted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">collcategories</span><span class="p">:</span>
                                    <span class="k">pass</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">collcategories</span><span class="p">[</span><span class="n">catsplitted</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">catsplitted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                    <span class="c"># category + subcategory</span>
                                    <span class="k">if</span> <span class="n">catsplitted</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">collcategories</span><span class="p">[</span><span class="n">catsplitted</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
                                        <span class="n">collcategories</span><span class="p">[</span><span class="n">catsplitted</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">catsplitted</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">del</span> <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;category&#39;</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">accomID</span><span class="p">]</span> <span class="o">=</span> <span class="n">accomdata</span>
                        <span class="n">accno</span> <span class="o">=</span> <span class="n">accno</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c"># this is indeed a set!</span>
                        <span class="n">setID</span> <span class="o">=</span> <span class="n">collection</span> <span class="o">+</span> <span class="s">&quot;:&quot;</span> <span class="o">+</span> <span class="n">accomset</span>
                        <span class="n">setdata</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;type&#39;</span><span class="p">:</span><span class="s">&quot;set&quot;</span><span class="p">,</span><span class="s">&#39;name&#39;</span><span class="p">:</span><span class="n">accomset</span><span class="p">}</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">setID</span><span class="p">]</span> <span class="o">=</span> <span class="n">setdata</span>
                        <span class="n">setdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">langdefaultpath</span><span class="p">,</span><span class="n">accomset</span><span class="p">)</span>
                        <span class="n">accomfiles</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">setdir</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">accomfile</span> <span class="ow">in</span> <span class="n">accomfiles</span><span class="p">:</span>
                            <span class="c"># For each accomplishment in this set...</span>
                            <span class="n">accompath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">langdefaultpath</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">accomset</span><span class="p">,</span><span class="n">accomfile</span><span class="p">))</span>
                            <span class="n">accomcfg</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
                            <span class="c"># check if there is a translated version...</span>
                            <span class="n">translatedpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">collpath</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lang</span><span class="p">),</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">accomset</span><span class="p">,</span><span class="n">accomfile</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">translatedpath</span><span class="p">):</span>
                                <span class="c"># yes, so use the translated file</span>
                                <span class="n">accomcfg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">translatedpath</span><span class="p">)</span>
                                <span class="n">langused</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c"># no. maybe there is a shorter language code?</span>
                                <span class="n">translatedpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">collpath</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">accomset</span><span class="p">,</span><span class="n">accomfile</span><span class="p">))</span>
                                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">translatedpath</span><span class="p">):</span>
                                    <span class="n">accomcfg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">translatedpath</span><span class="p">)</span>
                                    <span class="n">langused</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c"># no. fallback to default one</span>
                                    <span class="n">accomcfg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">accompath</span><span class="p">)</span>
                                    <span class="n">langused</span> <span class="o">=</span> <span class="n">langdefault</span>
                            <span class="n">accomdata</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">accomcfg</span><span class="o">.</span><span class="n">_sections</span><span class="p">[</span><span class="s">&quot;accomplishment&quot;</span><span class="p">])</span>
                            <span class="n">accomID</span> <span class="o">=</span> <span class="n">collection</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">accomfile</span><span class="p">[:</span><span class="o">-</span><span class="mi">15</span><span class="p">]</span>
                            <span class="k">if</span> <span class="s">&#39;author&#39;</span> <span class="ow">in</span> <span class="n">accomdata</span><span class="p">:</span>
                                <span class="n">collauthors</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;author&#39;</span><span class="p">])</span>
                            <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;accomplishment&quot;</span>
                            <span class="k">del</span> <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;__name__&#39;</span><span class="p">]</span>
                            <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;set&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">accomset</span>
                            <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;collection&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collection</span>
                            <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;lang&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">langused</span>
                            <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;base-path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collpath</span>
                            <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;script-path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">installpath</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s">&#39;scripts&#39;</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">accomset</span><span class="p">,</span><span class="n">accomfile</span><span class="p">[:</span><span class="o">-</span><span class="mi">15</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;.py&quot;</span><span class="p">))))</span>
                            <span class="k">if</span> <span class="s">&#39;category&#39;</span> <span class="ow">in</span> <span class="n">accomdata</span><span class="p">:</span>
                                <span class="n">cats</span> <span class="o">=</span> <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;category&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)</span>
                                <span class="n">categories</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">cats</span><span class="p">:</span>
                                    <span class="n">catsplitted</span> <span class="o">=</span> <span class="n">cat</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span>
                                    <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;categories&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cat</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">())</span>
                                    <span class="k">if</span> <span class="n">catsplitted</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">collcategories</span><span class="p">:</span>
                                        <span class="k">pass</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">collcategories</span><span class="p">[</span><span class="n">catsplitted</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">catsplitted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="c"># category + subcategory</span>
                                        <span class="k">if</span> <span class="n">catsplitted</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">collcategories</span><span class="p">[</span><span class="n">catsplitted</span><span class="p">[</span><span class="mi">0</span><span class="p">]]:</span>
                                            <span class="n">collcategories</span><span class="p">[</span><span class="n">catsplitted</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">catsplitted</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                <span class="k">del</span> <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;category&#39;</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">accomdata</span><span class="p">[</span><span class="s">&#39;categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">accomID</span><span class="p">]</span> <span class="o">=</span> <span class="n">accomdata</span>
                            <span class="n">accno</span> <span class="o">=</span> <span class="n">accno</span> <span class="o">+</span> <span class="mi">1</span>
                            
                <span class="c"># Look for extrainformation dir</span>
                <span class="n">extrainfodir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">collpath</span><span class="p">,</span><span class="s">&quot;extrainformation&quot;</span><span class="p">)</span>
                <span class="n">extrainfolist</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">extrainfodir</span><span class="p">)</span>
                <span class="n">extrainfo</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">extrainfofile</span> <span class="ow">in</span> <span class="n">extrainfolist</span><span class="p">:</span>
                    <span class="n">extrainfopath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">extrainfodir</span><span class="p">,</span><span class="n">extrainfofile</span><span class="p">)</span>
                    <span class="n">eicfg</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
                    <span class="n">eicfg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">extrainfopath</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">eicfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;label&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lang</span><span class="p">):</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">eicfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;label&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lang</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">eicfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;label&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">eicfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;label&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">label</span> <span class="o">=</span> <span class="n">eicfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;label&quot;</span><span class="p">,</span><span class="n">langdefault</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">eicfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;description&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lang</span><span class="p">):</span>
                        <span class="n">description</span> <span class="o">=</span> <span class="n">eicfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;description&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lang</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">eicfg</span><span class="o">.</span><span class="n">has_option</span><span class="p">(</span><span class="s">&quot;description&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="n">description</span> <span class="o">=</span> <span class="n">eicfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;description&quot;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">description</span> <span class="o">=</span> <span class="n">eicfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;description&quot;</span><span class="p">,</span><span class="n">langdefault</span><span class="p">)</span>
                        
                    <span class="n">extrainfo</span><span class="p">[</span><span class="n">extrainfofile</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;label&#39;</span><span class="p">:</span><span class="n">label</span><span class="p">,</span><span class="s">&#39;description&#39;</span><span class="p">:</span><span class="n">description</span><span class="p">}</span>
                
                <span class="c"># Store data about this colection</span>
                <span class="n">collectiondata</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;langdefault&#39;</span><span class="p">:</span><span class="n">langdefault</span><span class="p">,</span><span class="s">&#39;name&#39;</span><span class="p">:</span><span class="n">collectionname</span><span class="p">,</span> <span class="s">&#39;acc_num&#39;</span><span class="p">:</span><span class="n">accno</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">:</span><span class="s">&quot;collection&quot;</span><span class="p">,</span> <span class="s">&#39;base-path&#39;</span><span class="p">:</span> <span class="n">collpath</span><span class="p">,</span> <span class="s">&#39;categories&#39;</span> <span class="p">:</span> <span class="n">collcategories</span><span class="p">,</span> <span class="s">&#39;extra-information&#39;</span><span class="p">:</span> <span class="n">extrainfo</span><span class="p">,</span> <span class="s">&#39;authors&#39;</span><span class="p">:</span><span class="n">collauthors</span><span class="p">}</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">collection</span><span class="p">]</span> <span class="o">=</span> <span class="n">collectiondata</span>
          
        <span class="bp">self</span><span class="o">.</span><span class="n">_update_all_locked_and_completed_statuses</span><span class="p">()</span>
        <span class="c"># Uncomment following for debugging</span>
        <span class="c"># print self.accDB\</span>
        
    <span class="c"># ======= Access functions =======</span>
        
    <span class="k">def</span> <span class="nf">get_acc_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">accomID</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">get_acc_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">accomID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span>
        
    <span class="k">def</span> <span class="nf">get_acc_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">accomID</span><span class="p">][</span><span class="s">&#39;title&#39;</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">get_acc_description</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">accomID</span><span class="p">][</span><span class="s">&#39;description&#39;</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">get_acc_needs_signing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;needs-signing&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">accomID</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">accomID</span><span class="p">][</span><span class="s">&#39;needs-signing&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;false&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">accomID</span><span class="p">][</span><span class="s">&#39;needs-signing&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;False&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">accomID</span><span class="p">][</span><span class="s">&#39;needs-signing&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;no&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
    
    <span class="k">def</span> <span class="nf">get_acc_depends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="k">if</span> <span class="s">&#39;depends&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">accomID</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">accomID</span><span class="p">][</span><span class="s">&#39;depends&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
    
    <span class="k">def</span> <span class="nf">get_acc_is_unlocked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">accomID</span><span class="p">][</span><span class="s">&#39;locked&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">get_trophy_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_exists</span><span class="p">(</span><span class="n">accomID</span><span class="p">):</span>
            <span class="c"># hopefully an empty path will break something...</span>
            <span class="k">return</span> <span class="s">&quot;&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trophies_path</span><span class="p">,</span><span class="n">accomID</span> <span class="o">+</span> <span class="s">&quot;.trophy&quot;</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">get_acc_is_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">accomID</span><span class="p">][</span><span class="s">&#39;completed&#39;</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">get_acc_script_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">accomID</span><span class="p">][</span><span class="s">&#39;script-path&#39;</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">get_acc_icon</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">accomID</span><span class="p">][</span><span class="s">&#39;icon&#39;</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">get_acc_icon_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="n">imagesdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_cache</span><span class="p">,</span><span class="s">&#39;trophyimages&#39;</span><span class="p">)</span>
        <span class="n">imagesdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imagesdir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">get_acc_collection</span><span class="p">(</span><span class="n">accomID</span><span class="p">))</span>
        <span class="n">iconfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_icon</span><span class="p">(</span><span class="n">accomID</span><span class="p">)</span>
        <span class="n">iconfilename</span><span class="p">,</span> <span class="n">iconfileext</span> <span class="o">=</span> <span class="n">iconfile</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_is_unlocked</span><span class="p">(</span><span class="n">accomID</span><span class="p">):</span>
            <span class="n">iconfilename</span> <span class="o">=</span> <span class="n">iconfilename</span> <span class="o">+</span> <span class="s">&#39;-locked&#39;</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_is_completed</span><span class="p">(</span><span class="n">accomID</span><span class="p">):</span>
            <span class="n">iconfilename</span> <span class="o">=</span> <span class="n">iconfilename</span> <span class="o">+</span> <span class="s">&#39;-opportunity&#39;</span>
        <span class="n">iconfile</span> <span class="o">=</span> <span class="n">iconfilename</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">iconfileext</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">imagesdir</span><span class="p">,</span><span class="n">iconfile</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">get_acc_needs_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s">&#39;needs-information&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">accomID</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">accomID</span><span class="p">][</span><span class="s">&#39;needs-information&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)]</span>
    
    <span class="k">def</span> <span class="nf">get_acc_collection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">accomID</span><span class="p">][</span><span class="s">&#39;collection&#39;</span><span class="p">]</span>
        
<div class="viewcode-block" id="Accomplishments.get_acc_categories"><a class="viewcode-back" href="../../../index.html#accomplishments.daemon.api.Accomplishments.get_acc_categories">[docs]</a>    <span class="k">def</span> <span class="nf">get_acc_categories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">accomID</span><span class="p">][</span><span class="s">&#39;categories&#39;</span><span class="p">]</span>
    
    </div>
    <span class="k">def</span> <span class="nf">get_trophy_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_is_completed</span><span class="p">(</span><span class="n">accomID</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cfg</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
            <span class="n">cfg</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_trophy_path</span><span class="p">(</span><span class="n">accomID</span><span class="p">))</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cfg</span><span class="o">.</span><span class="n">_sections</span><span class="p">[</span><span class="s">&quot;trophy&quot;</span><span class="p">])</span>
    
    <span class="k">def</span> <span class="nf">get_collection_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">collection</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">collection</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">get_collection_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">collection</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">collection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_collections</span><span class="p">()</span>
        
    <span class="k">def</span> <span class="nf">get_collection_authors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">collection</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">collection</span><span class="p">][</span><span class="s">&#39;authors&#39;</span><span class="p">]</span>
        
    <span class="k">def</span> <span class="nf">get_collection_categories</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">collection</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">collection</span><span class="p">][</span><span class="s">&#39;categories&#39;</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">get_collection_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">collection</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">collection</span><span class="p">]</span>
        
    <span class="c"># ====== Listing functions ======</span>
    
    <span class="k">def</span> <span class="nf">list_accomplishments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">acc</span> <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accomslist</span><span class="p">()]</span>
        
    <span class="k">def</span> <span class="nf">list_trophies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">acc</span> <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accomslist</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_is_completed</span><span class="p">(</span><span class="n">acc</span><span class="p">)]</span>
        
    <span class="k">def</span> <span class="nf">list_opportunitues</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">acc</span> <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accomslist</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_is_completed</span><span class="p">(</span><span class="n">acc</span><span class="p">)]</span>
        
    <span class="k">def</span> <span class="nf">list_depending_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">acc</span> <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accomslist</span><span class="p">()</span> <span class="k">if</span> <span class="n">accomID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_depends</span><span class="p">(</span><span class="n">acc</span><span class="p">)]</span>
        
    <span class="k">def</span> <span class="nf">list_unlocked</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">acc</span> <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accomslist</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_is_unlocked</span><span class="p">(</span><span class="n">acc</span><span class="p">)]</span>
        
    <span class="k">def</span> <span class="nf">list_unlocked_not_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">acc</span> <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accomslist</span><span class="p">()</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_is_unlocked</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_is_completed</span><span class="p">(</span><span class="n">acc</span><span class="p">)]</span>        
    
    <span class="k">def</span> <span class="nf">list_collections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">col</span><span class="p">][</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;collection&#39;</span><span class="p">]</span>
    
    <span class="c"># ====== Viewer-specific functions ======</span>
        
    <span class="k">def</span> <span class="nf">build_viewer_database</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">accs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_accomplishments</span><span class="p">()</span>
        <span class="n">db</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">accs</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">append</span><span class="p">({</span> 
                <span class="s">&#39;title&#39;</span> <span class="p">:</span>           <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_title</span><span class="p">(</span><span class="n">acc</span><span class="p">),</span>
                <span class="s">&#39;accomplished&#39;</span> <span class="p">:</span>    <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_is_completed</span><span class="p">(</span><span class="n">acc</span><span class="p">),</span>
                <span class="s">&#39;locked&#39;</span> <span class="p">:</span>      <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_is_unlocked</span><span class="p">(</span><span class="n">acc</span><span class="p">),</span>
                <span class="s">&#39;iconpath&#39;</span> <span class="p">:</span>        <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_icon_path</span><span class="p">(</span><span class="n">acc</span><span class="p">),</span>
                <span class="s">&#39;collection&#39;</span> <span class="p">:</span>      <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_collection</span><span class="p">(</span><span class="n">acc</span><span class="p">),</span>
                <span class="s">&#39;collection-human&#39;</span> <span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">get_collection_name</span><span class="p">(</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_collection</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span> <span class="p">),</span>
                <span class="s">&#39;categories&#39;</span> <span class="p">:</span>      <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_categories</span><span class="p">(</span><span class="n">acc</span><span class="p">),</span>
                <span class="s">&#39;id&#39;</span> <span class="p">:</span>              <span class="n">acc</span> 
                <span class="p">})</span>
        <span class="k">return</span> <span class="n">db</span>
        
    <span class="c"># ========= Misc functions ===========</span>
    
    
    <span class="k">def</span> <span class="nf">accomplish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Accomplishing: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">accomID</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_exists</span><span class="p">(</span><span class="n">accomID</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;There is no such accomplishment.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span> <span class="c">#failure</span>
            
        <span class="c"># Check if is hasn&#39;t been already completed</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_is_completed</span><span class="p">(</span><span class="n">accomID</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Not accomplishing &quot;</span> <span class="o">+</span> <span class="n">accomID</span> <span class="o">+</span> <span class="s">&quot;, it has already been completed.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span> <span class="c">#success</span>
            
        <span class="c"># Check if this accomplishment is unlocked</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_is_unlocked</span><span class="p">(</span><span class="n">accomID</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;This accomplishment cannot be completed; it&#39;s locked.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
            
        <span class="n">coll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_coll_from_accomID</span><span class="p">(</span><span class="n">accomID</span><span class="p">)</span>
        <span class="n">accdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_data</span><span class="p">(</span><span class="n">accomID</span><span class="p">)</span>
        
        <span class="c"># Prepare extra-info</span>
        <span class="n">needsinformation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_needs_info</span><span class="p">(</span><span class="n">accomID</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">needsinformation</span><span class="p">:</span>
            <span class="n">accdata</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_extra_information</span><span class="p">(</span><span class="n">coll</span><span class="p">,</span><span class="n">i</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
            
        <span class="c"># Create .trophy file</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">RawConfigParser</span><span class="p">()</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s">&quot;trophy&quot;</span><span class="p">)</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;trophy&quot;</span><span class="p">,</span> <span class="s">&quot;version&quot;</span><span class="p">,</span> <span class="s">&quot;0.2&quot;</span><span class="p">)</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;trophy&quot;</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="n">accomID</span><span class="p">)</span>
        <span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;trophy&quot;</span><span class="p">,</span> <span class="s">&quot;date-accomplished&quot;</span><span class="p">,</span> <span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="s">&#39;needs-signing&#39;</span> <span class="ow">in</span> <span class="n">accdata</span><span class="p">:</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;trophy&quot;</span><span class="p">,</span> <span class="s">&#39;needs-signing&#39;</span><span class="p">,</span> <span class="n">accdata</span><span class="p">[</span><span class="s">&#39;needs-signing&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="s">&#39;needs-information&#39;</span> <span class="ow">in</span> <span class="n">accdata</span><span class="p">:</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;trophy&quot;</span><span class="p">,</span> <span class="s">&#39;needs-information&#39;</span><span class="p">,</span> <span class="n">accdata</span><span class="p">[</span><span class="s">&#39;needs-information&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">accdata</span><span class="p">[</span><span class="s">&#39;needs-information&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span><span class="o">.</span><span class="n">lstrip</span><span class="p">()</span>
                <span class="n">cp</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&quot;trophy&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">accdata</span><span class="p">[</span><span class="n">a</span><span class="p">])</span>
        <span class="n">trophypath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trophy_path</span><span class="p">(</span><span class="n">accomID</span><span class="p">)</span>
        <span class="n">dirpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">trophypath</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dirpath</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dirpath</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">trophypath</span><span class="p">)</span>
        <span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">trophypath</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">cp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
        <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_needs_signing</span><span class="p">(</span><span class="n">accomID</span><span class="p">):</span>
            <span class="c"># The accomplishment does not need signing!</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">trophy_received</span><span class="p">(</span><span class="n">accomID</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_display_accomplished_bubble</span><span class="p">(</span><span class="n">accomID</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_display_unlocked_bubble</span><span class="p">(</span><span class="n">accomID</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mark_as_completed</span><span class="p">(</span><span class="n">accomID</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_scripts</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">set_daemon_session_start</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;setting&quot;</span><span class="p">)</span>
            <span class="n">command</span> <span class="o">=</span> <span class="s">&quot;twistd -noy &quot;</span> <span class="o">+</span> <span class="n">daemon_exec_dir</span> <span class="o">+</span> <span class="s">&quot;/accomplishments-daemon --logfile=&quot;</span> <span class="o">+</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_cache</span><span class="p">,</span> <span class="s">&quot;logs&quot;</span><span class="p">,</span> <span class="s">&quot;daemon.log&quot;</span><span class="p">)</span>
            <span class="n">filetext</span> <span class="o">=</span> <span class="s">&quot;[Desktop Entry]</span><span class="se">\n\</span>
<span class="s">Type=Application</span><span class="se">\n\</span>
<span class="s">Encoding=UTF-8</span><span class="se">\n\</span>
<span class="s">Name=Accomplishments Daemon</span><span class="se">\n\</span>
<span class="s">Exec=&quot;</span> <span class="o">+</span> <span class="n">command</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n\</span>
<span class="s">NoDisplay=true&quot;</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_autostart</span><span class="p">,</span> <span class="s">&quot;accomplishments-daemon.desktop&quot;</span><span class="p">)</span>
            <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">filetext</span><span class="p">)</span>
            <span class="nb">file</span><span class="o">.</span><span class="n">close</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_config_file_item</span><span class="p">(</span><span class="s">&quot;config&quot;</span><span class="p">,</span> <span class="s">&quot;daemon_sessionstart&quot;</span><span class="p">,</span> <span class="s">&quot;true&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dir_autostart</span><span class="p">,</span> <span class="s">&quot;accomplishments-daemon.desktop&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_config_file_item</span><span class="p">(</span><span class="s">&quot;config&quot;</span><span class="p">,</span> <span class="s">&quot;daemon_sessionstart&quot;</span><span class="p">,</span> <span class="s">&quot;false&quot;</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">get_daemon_session_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config_value</span><span class="p">(</span><span class="s">&quot;config&quot;</span><span class="p">,</span> <span class="s">&quot;daemon_sessionstart&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">set_block_ubuntuone_notification_bubbles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">value</span><span class="p">):</span>
        <span class="n">u1configdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">xdg</span><span class="o">.</span><span class="n">BaseDirectory</span><span class="o">.</span><span class="n">xdg_config_home</span><span class="p">,</span> <span class="s">&quot;ubuntuone&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">u1configdir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">u1configdir</span><span class="p">)</span>

        <span class="n">cfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">u1configdir</span><span class="p">,</span> <span class="s">&quot;syncdaemon.conf&quot;</span><span class="p">)</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
        <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cfile</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s">&quot;notifications&quot;</span><span class="p">):</span>
                <span class="n">config</span><span class="o">.</span><span class="n">add_section</span><span class="p">(</span><span class="s">&#39;notifications&#39;</span><span class="p">)</span>
            <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;notifications&#39;</span><span class="p">,</span> <span class="s">&#39;show_all_notifications&#39;</span><span class="p">,</span> <span class="s">&quot;False&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s">&quot;notifications&quot;</span><span class="p">):</span>
                <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s">&#39;notifications&#39;</span><span class="p">,</span> <span class="s">&#39;show_all_notifications&#39;</span><span class="p">,</span> <span class="s">&quot;True&quot;</span><span class="p">)</span>
        
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">cfile</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">configfile</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">configfile</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">get_block_ubuntuone_notification_bubbles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">u1configdir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">xdg</span><span class="o">.</span><span class="n">BaseDirectory</span><span class="o">.</span><span class="n">xdg_config_home</span><span class="p">,</span> <span class="s">&quot;ubuntuone&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">u1configdir</span><span class="p">):</span>
            
            <span class="n">cfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">u1configdir</span><span class="p">,</span> <span class="s">&quot;syncdaemon.conf&quot;</span><span class="p">)</span>

            <span class="n">config</span> <span class="o">=</span> <span class="n">ConfigParser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
            <span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cfile</span><span class="p">)</span>

            <span class="k">if</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">cfile</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">has_section</span><span class="p">(</span><span class="s">&quot;notifications&quot;</span><span class="p">):</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;notifications&#39;</span><span class="p">,</span> <span class="s">&#39;show_all_notifications&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&quot;false&quot;</span> <span class="ow">or</span> <span class="n">val</span> <span class="o">==</span> <span class="s">&quot;False&quot;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
    
    <span class="k">def</span> <span class="nf">_coll_from_accomID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">accomID</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">_display_accomplished_bubble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_notifications</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">pynotify</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">pynotify</span><span class="o">.</span><span class="n">is_initted</span><span class="p">()</span> <span class="ow">or</span> <span class="n">pynotify</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s">&quot;icon-summary-body&quot;</span><span class="p">)):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">pynotify</span><span class="o">.</span><span class="n">Notification</span><span class="p">(</span>
                <span class="n">_</span><span class="p">(</span><span class="s">&quot;You have accomplished something!&quot;</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_title</span><span class="p">(</span><span class="n">accomID</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_icon_path</span><span class="p">(</span><span class="n">accomID</span><span class="p">)</span> <span class="p">)</span>
            <span class="n">n</span><span class="o">.</span><span class="n">set_hint_string</span><span class="p">(</span><span class="s">&#39;append&#39;</span><span class="p">,</span> <span class="s">&#39;allowed&#39;</span><span class="p">)</span>
            <span class="n">n</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">_display_unlocked_bubble</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="n">unlocked</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_depending_on</span><span class="p">(</span><span class="n">accomID</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">unlocked</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">show_notifications</span> <span class="o">==</span> <span class="bp">True</span> <span class="ow">and</span> <span class="n">pynotify</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">pynotify</span><span class="o">.</span><span class="n">is_initted</span><span class="p">()</span> <span class="ow">or</span> <span class="n">pynotify</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="s">&quot;icon-summary-body&quot;</span><span class="p">)):</span>
                <span class="n">message</span> <span class="o">=</span> <span class="p">(</span><span class="n">N_</span><span class="p">(</span><span class="s">&quot;You have unlocked </span><span class="si">%s</span><span class="s"> new opportunity.&quot;</span><span class="p">,</span><span class="s">&quot;You have unlocked </span><span class="si">%s</span><span class="s"> new opportunities.&quot;</span><span class="p">,</span><span class="n">unlocked</span><span class="p">)</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">unlocked</span><span class="p">))</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">pynotify</span><span class="o">.</span><span class="n">Notification</span><span class="p">(</span>
                    <span class="n">_</span><span class="p">(</span><span class="s">&quot;Opportunities Unlocked!&quot;</span><span class="p">),</span> <span class="n">message</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_media_file</span><span class="p">(</span><span class="s">&quot;unlocked.png&quot;</span><span class="p">))</span>
                <span class="n">n</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">accomslist</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s">&#39;type&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="s">&quot;accomplishment&quot;</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">k</span>
            
    <span class="k">def</span> <span class="nf">_get_is_asc_correct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filepath</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="c"># the .asc signed file exists, so let&#39;s verify that it is correctly</span>
            <span class="c"># signed by the Matrix</span>
            <span class="n">trophysigned</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">trophy</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">],</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">gpgme</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>

            <span class="n">signed</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">trophysigned</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">plaintext</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">(</span><span class="n">trophy</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="n">sig</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">verify</span><span class="p">(</span><span class="n">signed</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">plaintext</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c"># No Sig</span>
                <span class="k">return</span> <span class="bp">False</span>

            <span class="k">if</span> <span class="n">sig</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">status</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># Bad Sig</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c"># Correct!</span>
                <span class="c"># result = {&#39;timestamp&#39;: sig[0].timestamp, &#39;signer&#39;: sig[0].fpr}</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">msg</span><span class="p">(</span><span class="s">&quot;Cannot check if signature is correct, because file </span><span class="si">%s</span><span class="s"> does not exist&quot;</span> <span class="o">%</span> <span class="n">filepath</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">False</span>
            
    <span class="k">def</span> <span class="nf">_check_if_acc_is_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="n">trophypath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trophy_path</span><span class="p">(</span><span class="n">accomID</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">trophypath</span><span class="p">):</span>
            <span class="c"># There is no trophy file</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_needs_signing</span><span class="p">(</span><span class="n">accomID</span><span class="p">):</span>
            <span class="c"># The trophy does not need a signature</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># The trophy needs to be signed</span>
            <span class="n">ascpath</span> <span class="o">=</span> <span class="n">trophypath</span> <span class="o">+</span> <span class="s">&quot;.asc&quot;</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">ascpath</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_is_asc_correct</span><span class="p">(</span><span class="n">ascpath</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">_check_if_acc_is_locked</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="n">dep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_depends</span><span class="p">(</span><span class="n">accomID</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dep</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">locked</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dep</span><span class="p">:</span>
                <span class="c"># If at least one dependency is not completed...</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acc_is_completed</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
                    <span class="n">locked</span> <span class="o">=</span> <span class="bp">True</span>
                    <span class="k">break</span>
            <span class="k">return</span> <span class="n">locked</span>
            
    <span class="k">def</span> <span class="nf">_update_all_locked_and_completed_statuses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">accs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_accomplishments</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">accs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">acc</span><span class="p">][</span><span class="s">&#39;completed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_if_acc_is_completed</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">accs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">acc</span><span class="p">][</span><span class="s">&#39;locked&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_if_acc_is_locked</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
            
    <span class="k">def</span> <span class="nf">_mark_as_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">accomID</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">accomID</span><span class="p">][</span><span class="s">&#39;completed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">accs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_depending_on</span><span class="p">(</span><span class="n">accomID</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">acc</span> <span class="ow">in</span> <span class="n">accs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">accDB</span><span class="p">[</span><span class="n">acc</span><span class="p">][</span><span class="s">&#39;locked&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_if_acc_is_locked</span><span class="p">(</span><span class="n">acc</span><span class="p">)</span>
            
    <span class="c">#Other significant system functions</span>
    <span class="k">def</span> <span class="nf">get_API_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;0.2&quot;</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../../../index.html">Ubuntu Accomplishments Daemon 0.3 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Jono Bacon.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>